services:
  app:
    build: .
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    logging:
      options:
        max-size: '10m'
        max-file: '3'
    ports:
      - '${APP_PUBLIC_PORT:-8080}:${SERVER_PORT:-8080}'
    volumes:
      - './logs:/app/logs'
      - '${SSL_CERTS_DIR:-./certs}:/certs:ro'
    environment:
      - 'SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-}'
      - 'SERVER_PORT=${SERVER_PORT:-8080}'
      - 'SERVER_SSL_CERTIFICATE=${SERVER_SSL_CERTIFICATE:-}'
      - 'SERVER_SSL_PRIVATE_KEY=${SERVER_SSL_PRIVATE_KEY:-}'
      - 'SPRING_DATASOURCE_URL=${DATABASE_URL}'
      - 'SPRING_DATASOURCE_USERNAME=${POSTGRES_USER}'
      - 'SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD}'
      - 'JWT_SECRET=${JWT_SECRET}'
      - 'REDIS_HOST=${REDIS_HOST:-redis}'
      - 'REDIS_PORT=${REDIS_PORT:-6379}'
      - 'KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}'
      - 'APP_SOCIAL_ASYNC_ENABLED=${APP_SOCIAL_ASYNC_ENABLED:-true}'
      - 'APP_SOCIAL_REDIS_ENABLED=${APP_SOCIAL_REDIS_ENABLED:-true}'
      - 'APP_SOCIAL_KAFKA_TOPIC=${APP_SOCIAL_KAFKA_TOPIC:-social-events}'
      - 'APP_SOCIAL_REDIS_STATS_TTL=${APP_SOCIAL_REDIS_STATS_TTL:-PT24H}'
      - 'APP_SOCIAL_REDIS_LIKES_TTL=${APP_SOCIAL_REDIS_LIKES_TTL:-PT24H}'
      - 'APP_SOCIAL_REDIS_POSTS_TTL=${APP_SOCIAL_REDIS_POSTS_TTL:-PT168H}'
    healthcheck:
      test: ["CMD-SHELL", "if [ \"${SERVER_PORT:-8080}\" = \"443\" ]; then wget --no-check-certificate -qO- \"https://localhost:${SERVER_PORT:-8080}/actuator/health/readiness\" | grep -q '\"status\":\"UP\"'; else wget -qO- \"http://localhost:${SERVER_PORT:-8080}/actuator/health/readiness\" | grep -q '\"status\":\"UP\"'; fi || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 40s

  redis:
    image: 'redis:7.4-alpine'
    restart: unless-stopped
    command: ['redis-server', '--appendonly', 'yes']
    logging:
      options:
        max-size: '10m'
        max-file: '3'
    volumes:
      - 'redis_data:/data'
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s

  kafka:
    image: 'apache/kafka:3.9.0'
    restart: unless-stopped
    logging:
      options:
        max-size: '10m'
        max-file: '3'
    environment:
      - 'KAFKA_NODE_ID=1'
      - 'KAFKA_PROCESS_ROLES=broker,controller'
      - 'KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER'
      - 'KAFKA_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093'
      - 'KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092'
      - 'KAFKA_INTER_BROKER_LISTENER_NAME=PLAINTEXT'
      - 'KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT'
      - 'KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:9093'
      - 'KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1'
      - 'KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1'
      - 'KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1'
      - 'KAFKA_AUTO_CREATE_TOPICS_ENABLE=true'
      - 'CLUSTER_ID=MkU3OEVBNTcwNTJENDM2Qk'
    volumes:
      - 'kafka_data:/tmp/kraft-combined-logs'
    healthcheck:
      test: ['CMD-SHELL', '/opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server localhost:9092 >/dev/null 2>&1']
      interval: 15s
      timeout: 10s
      retries: 8
      start_period: 30s

volumes:
  redis_data:
  kafka_data:
